name: Pa11y A11y Audit

on:
  push:
  pull_request:

jobs:
  pa11y:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Serve index.html
        run: |
          set -euo pipefail
          python3 -V || (sudo apt-get update && sudo apt-get install -y python3)
          # Start a simple HTTP server and capture logs
          python3 -m http.server 8080 > /tmp/http.log 2>&1 &
          # Wait for server to respond
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8080/index.html >/dev/null; then
              echo "Server is up"
              break
            fi
            sleep 1
          done
          # One final check and headers dump for debugging
          curl -I http://localhost:8080/index.html || (echo "Server did not respond" >&2; exit 1)

      - name: Run Pa11yCI (Node.js action)
        uses: Makepad-fr/pa11y-action@main
        with:
          url: http://localhost:8080/index.html
          standard: WCAG2AA
          reporter: json
          threshold: "0"          # fail on any issue
          wait: "500"             # small delay for rendering
          node_version: "24"

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pa11y-report
          path: |
            pa11y-report.json
          if-no-files-found: warn

      - name: Show a few lines for debugging
        if: failure()
        run: |
          echo "--- http server log (tail) ---"
          tail -n 100 /tmp/http.log || true